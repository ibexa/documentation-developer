# CDP activation  [[% include 'snippets/experience_badge.md' %]] [[% include 'snippets/commerce_badge.md' %]]

## Configuration

To configure Ibexa CDP you have to edit the `config/packages/ibexa_cdp.yaml` file:

```yaml
ibexa:
    system:
        default:
            cdp:
                account_number: 123456
                user_data_streaming:
                    stream_id: 00000000-00000000-00000000-00000000
                activations:
                    client_id: '%env(CDP_ACTIVATION_CLIENT_ID)%'
                    client_secret: '%env(CDP_ACTIVATION_CLIENT_SECRET)%'
                    segment_group_identifier: example_segment_group_identifier
```

All configuration settings are described bellow.
You can follow them step by step to set up your Ibexa CDP.

### Segment group

First, create a segment group in the Back Office.
It will serve as a container for all segments data generated by Ibexa CDP.
Go to **Admin** -> **Segments** and select **Create**.
Fill in name and identifier for a segment group.
Choose wisely, as once connected to CDP Segment Group cannot be changed.

![Creating a new segment group](img/cdp_create_segment_group.png)

Next, add a segment group identifier to the configuration.

!!! caution "Ibexa CDP Segment Group"

    Once you create the Segment Group in the Back Office and connect it to Ibexa CDP you cannot change it in any way, including edit its name.

## Account number

Now, fill in the account number.
Log in to Ibexa CDP and select available accounts in the top right corner.

![List of available accounts](img/cdp_accounts.png)

A pop-up window will appear with a list of all available accounts and their numbers.

![Account number](img/cdp_account_number.png)

## User Data Streaming

You need to specify a source of the user data that Ibexa CDP will connect to.
To do so, go to **Data Manager** in **Tools** section and select **Create new dataflow**.
It will take you to a Dataflow Creator, where in five steps you will set up a data streaming.

### General Information

In the **General Information** section specify dataflow name,
choose **Stream File** as a source of user data and **CDP** as a destination,
where they will be sent for processing.

### Download

In the **Download** section select **Stream file**. 
Copy generated steam ID and paste it into the `config/packages/ibexa_cdp.yaml` file under `stream_id`.
It allows you to establish a datastream from the Streaming API into the Data Manager.

Next, you need to export your user data to the CDP.
Got to your installation and use this command:

```bash
php bin/console ibexa:cdp:stream-user-data --draft
```

There are two versions of this command `--draft/--no-draft`.
The first one is used to send the test user data to the Data Manager.
If it passes a validation test, you can use the latter one to send a full version.

Next, go back to Ibexa CDP and select **Validate & download**.
If the file passes, you will see a confirmation message.
Export data one more time with `--no-draft` option on and move on to the **File mapping** section.

### File mapping

Mapping is completed automatically, the system fills all required information and shows available columns with datapoints on the right.
You can change their names if needed or disallow empty fields by checking **Mandatory**.
If the provided file contains empty values, this option is not available.

If provided file is not recognized, the system will require you to fill in the parsing-options manually or select an appropriate format.
If you make any alterations, select the **Parse File** to generate columns with new data.

### Transform & Map

In the **Transform & Map** section you transform data and map it to a schema.
At this point, you can map **emial** to **email** and **id** to **integer** to get custom columns.



​
* Dalszy krok to ustawianie Audience w Builderze:
  ​
    * To jest dobrze pokazane na filmie. Należy pamiętać, że na sam koniec Audience musi zostać podpięte do aktywacji. Da się to zrobić z listy Audiences (zdaje się "link to activation") albo z ekranu aktywacji jeżeli dobrze pamiętam.
      ​
* Jeżeli to wszystko zostanie zrobione to teoretycznie wszystko powinno już działać i dane w ciągu kilku minut będą eksportowane do DXP. Czasem coś może nawalić i wtedy ciężko ustalić co się stało. Dlatego w dokumentacji należy wspomnieć, że wszystkie requesty z CDP są logowane z severity `debug`
  ​
* Jak wszystko mamy gotowe to ostanim krokiem jest podpięcie Trackingu. Póki co nie mamy tego zrobionego automatycznie i należy korzystać z kodu JavaScript, który opisuje Raptor w swojej dokumentacji: https://support.raptorsmartadvisor.com/hc/en-us/articles/115000656909-Client-side-Tracking
  ​
  Te snippety, które tam są należy umieścić w swoich szablonach Twig. Są tam dwie główne części: pierwszą umieszczamy między tagami `<head></head>` (The Head Tracking Script, zwróć uwagę że należy tam podać customerId czyli nr konta w dashboardzie Raptora), a drugą gdzieś w body po akceptacji zgody na ciasteczka.
  ​
  Jak wstawimy te dwa snippety to jeszcze nic się nie będzie śledziło. Musimy sami zdecydować jakie zachowania będziemy śledzić i robi się to wklejając w odpowiednie miejsce (np. w szablonie dla LP jeżeli chcemy zliczać wejścia na landing page) kod, który pushuje dane do Raptora:
  ​
  ```js
  raptor.trackEvent('visit', ..., ...);
  ```
​
Pełna lista eventów jest w dokumentacji np. tutaj: https://support.raptorsmartadvisor.com/hc/en-us/articles/201912411-Tracking-Events
​
Ważne jest też przesłanie ID zalogowanego użytkownika w podobny sposób:
​
```js
raptor.push("setRuid","USER_ID_HERE")
```

## Activation

Activation synchronises data from Ibexa CDP to the Ibexa DXP.
When you specify a segment, you can Activate it on multiple communication channels, such as newsletters or commercials.
You can configure multiple activations based on one user data streaming.

First, select **Activations** from the menu bar and create a new **Ibexa** activation.
Specify name of your activation, select `userid` as **Person Identifier** and click **Next**.

![General Information - Activation](img/cdp_activation_general_info.png)

Next, you can fill in **Ibexa information** they must match the ones provided in the YAML configuration:

- **Client secret** and **Client id** - are used to authenticate against Webhook endpoint. In the configuration they are taken from environment variables in `.env` file.

- **Segment Group Identifier** - identifier of the segment group in Ibexa DXP. It points to a segment group where all the CDP audiences will be stored.
- **Base URL** - URL of your instance with added `/cdp/webhook` at the end.

![Ibexa Information - Activation](img/cdp_activation_ibexa_info.png)

Finally, you can specify the audiences.





