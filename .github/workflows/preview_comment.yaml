name: "Post preview links for changed files"

on:
    pull_request: ~
    workflow_call:
        inputs:
            project:
              description: 'The project to build (dev doc, user doc)'
              default: ''
              required: false
              type: string

jobs:
    post-preview-links:
        name: Post preview links for changed files
        runs-on: ubuntu-latest
        permissions:
            # Needed to manage the comment
            pull-requests: write
            # Needed to checkout private repositories
            contents: read

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            -   name: Create comment for changed files
                run: |
                    file_limit=100
                    build_url="https://ez-systems-developer-documentation--${{ github.event.pull_request.number }}.com.readthedocs.build/${{inputs.project}}en/${{ github.event.pull_request.number }}/"

                    md_change_list=$(git diff --name-only HEAD "origin/$GITHUB_BASE_REF" -- docs/ | grep -E "^docs\/.*\.md$" | sed -E "s|^docs/(.*)\.md$|- [docs/\1.md](${build_url}\1/)|")
                    par_change_list=$(git diff --name-only HEAD "origin/$GITHUB_BASE_REF" -- docs/api/php_api/php_api_reference/ | grep -E "^docs\/.*\.html$" | sed -E "s|^docs/(.*\.html)$|- [docs/\1](${build_url}\1)|")
                    change_count=$(( $(echo "$md_change_list" | wc -l) + $(echo "$par_change_list" | wc -l) ))

                    if [[ "$md_change_list$par_change_list" -eq '' ]] ; then
                      comment="Preview of modified files: no change to preview."
                    elif [[ $change_count -gt $file_limit ]] ; then
                      comment="Preview of modified files: Too many files modified in a single PR, preview link list is skipped. ($change_count files &gth; $file_limit)"
                    else
                      comment="# Preview of modified files\n\nPreview of modified Markdown:\n\n$md_change_list\n\nPreview of modified PHP API Reference:\n\n$par_change_list"                    
                    fi

                    echo -e "$comment" > comment.md

            -   name: Find comment
                id: find-comment
                uses: peter-evans/find-comment@v3
                with:
                    issue-number: ${{ github.event.pull_request.number }}
                    comment-author: 'github-actions[bot]'
                    body-includes: 'Preview of modified files'

            -   name: Create or update comment
                uses: peter-evans/create-or-update-comment@v4
                with:
                    comment-id: ${{ steps.find-comment.outputs.comment-id }}
                    issue-number: ${{ github.event.pull_request.number }}
                    body-path: comment.md
                    edit-mode: replace
